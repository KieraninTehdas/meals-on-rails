# Copilot Instructions for Meals on Rails

## Project Overview

Meals on Rails is a Rails 7.2 web application for managing meal plans and recipes. It uses a PWA-like architecture with Hotwire (Turbo + Stimulus) for frontend interactivity, Tailwind CSS for styling, and SQLite for the database.

**Key Domain:**
- **MealPlan**: Date-based plan (start_date, end_date) containing multiple meals
- **Meal**: Individual meal with optional association to a RecipeBook (can reference a page number)
- **MealPlanMeal**: Join table tracking meals within a plan, includes an `eaten?` boolean status
- **RecipeBook**: Container for recipes with associated meals

Scopes on MealPlan: `past`, `future`, `current` (based on start_date/end_date vs today).

## Build, Test, and Lint Commands

### Development Server
```bash
# Run all processes (Rails server, JS build watcher, CSS build watcher)
./bin/dev
# Or with foreman directly:
foreman start -f Procfile.dev
```

### Testing
```bash
# Run all tests
bundle exec rspec

# Run tests for a specific file
bundle exec rspec spec/models/meal_plan_spec.rb

# Run a specific test
bundle exec rspec spec/models/meal_plan_spec.rb:10
```

RSpec configuration is minimal (see .rspec). Tests use `rails_helper` which loads the Rails environment.

### Linting and Security
```bash
# Lint code (Omakase style from rubocop-rails-omakase)
bundle exec rubocop

# Fix linting issues automatically
bundle exec rubocop -A

# Security scan for vulnerabilities
bin/brakeman --no-pager
```

### Asset Building
```bash
# Build JavaScript (esbuild)
yarn build

# Watch for JS changes
yarn build --watch

# Build CSS (Tailwind)
yarn build:css

# Watch for CSS changes
yarn build:css --watch
```

## Architecture Patterns

### Controllers
- Standard RESTful structure: `meals_controller.rb`, `meal_plans_controller.rb`, `recipe_books_controller.rb`
- Custom actions use `member` or `collection` routes (e.g., `shopping-list`, `search`, `past_meal_plans`)
- Simple logic; business logic belongs in models or services

### Models
- All models inherit from `ApplicationRecord`
- Use validations at the model level
- Associations use `dependent: :delete_all` for join tables
- Model concerns live in `app/models/concerns/`

### Views
- Organized by controller (e.g., `app/views/meal_plans/`)
- Use Stimulus controllers for interactivity; keep logic minimal
- Tailwind CSS for styling (no separate CSS files needed in most cases)

### Database
- SQLite in development and test (see config/database.yml)
- Migrations auto-generated by Rails
- Use `db:migrate` and `db:rollback` as normal

## Key Conventions

1. **Path Naming**: Resource paths use dashes (e.g., `/meal-plans`, `/recipe-books`) while controller/model names use underscores
2. **Validation Logic**: Complex multi-field validation goes in private methods with a `?` suffix (e.g., `end_after_start?`)
3. **Scopes**: Use meaningful names like `past`, `future`, `current` for reusable query logic
4. **Booleans**: The `eaten?` flag on MealPlanMeal drives meal completion tracking
5. **Optional Associations**: Meal â†’ RecipeBook is optional, but if page_number is set, recipe_book must be present
6. **Hotwire Integration**: Use Turbo for page navigation and Stimulus for DOM manipulation; avoid excessive JavaScript

## Development Workflow

1. Create migrations: `bin/rails generate migration MigrationName`
2. Create models/controllers: `bin/rails generate model ModelName` or `bin/rails generate controller ControllerName`
3. Keep views simple; use Stimulus for interactivity
4. Run tests locally before pushing: `bundle exec rspec`
5. RuboCop issues must pass in CI: `bundle exec rubocop`
6. Security scan passes: `bin/brakeman --no-pager`
